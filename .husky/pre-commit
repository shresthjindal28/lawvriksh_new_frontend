staged_files=$(git diff --cached --name-only -z --diff-filter=ACM | tr '\0' '\n' | grep -E '\.(js|jsx|ts|tsx|mdx)$' | grep -v '^node_modules/' | grep -v '^.next/' | grep -v '^src/components/layout/Topbar.client.tsx$' | grep -v '^src/utils/editorHelper.ts$' || true)

if [ -n "$staged_files" ]; then
  grep_status=0
  git grep -nE "<img\b" -- $staged_files || grep_status=$?

  if [ $grep_status -eq 0 ]; then
    echo "âŒ Found <img> tags. Use Next.js <Image> instead."
    exit 1
  elif [ $grep_status -gt 1 ]; then
    echo "âŒ Pre-commit check failed while scanning for <img> tags."
    exit $grep_status
  fi
fi

# Run lint-staged
npx lint-staged || exit $?

# Run build check
echo "ğŸ”¨ Running production build check..."
npm run build || {
  echo "âŒ Build failed. Fix errors before committing."
  exit 1
}

exit 0
